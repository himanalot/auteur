<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug Test</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
    </style>
</head>
<body>
    <h1>WebSocket Debug Test</h1>
    <button onclick="testConnection()">Test WebSocket Connection</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="logs"></div>

    <script>
        let ws = null;
        let logContainer = document.getElementById('logs');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(div);
            console.log(message);
        }

        function clearLogs() {
            logContainer.innerHTML = '';
        }

        function testConnection() {
            if (ws) {
                ws.close();
                ws = null;
            }

            log('üß™ Testing WebSocket connection to ws://localhost:3001/api/chat/stream...', 'info');

            try {
                ws = new WebSocket('ws://localhost:3001/api/chat/stream');

                ws.onopen = function() {
                    log('‚úÖ WebSocket connected successfully!', 'success');
                    
                    // Send test message
                    const testMessage = {
                        type: 'chat_start',
                        data: {
                            message: 'Hello from browser test',
                            model: 'claude',
                            conversation: []
                        }
                    };
                    
                    log('üì§ Sending test message...', 'info');
                    ws.send(JSON.stringify(testMessage));
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì® Received: ${JSON.stringify(data, null, 2)}`, 'success');
                    } catch (e) {
                        log(`üì® Received (raw): ${event.data}`, 'info');
                    }
                };

                ws.onerror = function(error) {
                    log(`‚ùå WebSocket error: ${error}`, 'error');
                    console.error('WebSocket error:', error);
                };

                ws.onclose = function(event) {
                    log(`üîå WebSocket closed: ${event.code} ${event.reason}`, 'info');
                };

            } catch (error) {
                log(`‚ùå Failed to create WebSocket: ${error.message}`, 'error');
            }
        }

        // Auto-test on page load
        setTimeout(testConnection, 1000);
    </script>
</body>
</html>